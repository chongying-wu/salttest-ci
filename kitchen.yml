---
<% vagrant = system('gem list -i kitchen-vagrant 2>/dev/null >/dev/null') %>
<% version = '2018.3.4' %>
<% platformsfile = ENV['SALT_KITCHEN_PLATFORMS'] || '.kitchen/platforms.yml' %>
<% driverfile = ENV['SALT_KITCHEN_DRIVER'] || '.kitchen/driver.yml' %>
<% verifierfile = ENV['SALT_KITCHEN_VERIFIER'] || '.kitchen/verifier.yml' %>

<% if File.exists?(driverfile) %>
<%= ERB.new(File.read(driverfile)).result %>
<% else %>
driver:
  name: docker
  use_sudo: false
  hostname: salt
  privileged: true
  username: kitchen
  volume:
    - /var/run/docker.sock:/docker.sock
  cap_add:
    - sys_admin
  disable_upstart: false
  provision_command:
    - echo 'L /run/docker.sock - - - - /docker.sock' > /etc/tmpfiles.d/docker.conf
transport:
  name: sftp
<% end %>

provisioner:
  name: salt_solo
  salt_install: bootstrap
  salt_version: 2018.3.4
  salt_bootstrap_url: https://bootstrap.saltstack.com
  salt_bootstrap_options: -X stable <%= @version %>
  log_level: info
  sudo: true
  require_chef: false
  retry_on_exit_code:
    - 139
  max_retries: 2
  remote_states:
    name: git://github.com/chongying-wu/salt-jenkins.git
    branch: 2018.3
    repo: git
    testingdir: /testing
  salt_copy_filter:
    - __pycache__
    - '*.pyc'
    - .bundle
    - .tox
    - .nox
    - .kitchen
    - artifacts
    - Gemfile.lock
  state_top:
    base:
      "os:Windows":
        - match: grain
        - windows
      "*":
        - <%= ENV['KITCHEN_STATE'] || 'git.minimal' %>
  pillars:
    top.sls:
      base:
        "*":
          - jenkins
        "os:Windows":
          - match: grain
          - windows
    jenkins.sls:
      testing_dir: "{{salt.config.get('root_dir')|replace('\\', '\\\\')}}/testing"
      clone_repo: false
      salttesting_namespec: salttesting==2017.6.1
    windows.sls:
      virtualenv_path: 'c:\Python27\Scripts\pip.exe'
<% if File.exists?(platformsfile) %>
<%= ERB.new(File.read(platformsfile)).result %>
<% else %>
platforms:
  - name: ubuntu-18.04
    driver_config:
      image: harbor.shopeemobile.com/devops-sz/ubuntu:18.04
      run_command: /lib/systemd/systemd
<% end %>
suites:
  - name: py3
    verifier:
      python_bin: python3
    provisioner:
      pillars:
        jenkins.sls:
          py3: true


verifier:
  name: shell
  remote_exec: true
  sudo: true
  command: |
    cd /tmp/kitchen/testing/
    sudo apt-get install libcurl4-gnutls-dev  -y && sudo apt-get install libghc-gnutls-dev -y
    nox -e 'pytest-zeromq-3(coverage=False)' -- '-m' 'slow_test' '--run-slow' '-v' tests/integration/modules/test_test.py
